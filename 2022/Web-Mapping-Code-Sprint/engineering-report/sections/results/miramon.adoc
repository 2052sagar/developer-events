[[results_miramon]]
=== Miramon Map Browser

Sprint participants from CREAF
worked mainly on improving the implementation of a web map client, called MiraMon Map Browser, to better accommodate OGC API Maps, OGC API Map Tiles support (e.g. extending the Miramon Map Browser to support the addition of layers from implementations of OGC API - Maps) and also to experiment on how to apply tessellation in an implementation of the OGC Sensor thing API. The analysis covered tiles generated at the server side as well as client side tiled requests to STA.

==== OGC API – Maps and Map Tiles implementation

To begin with, an overhaul of the code has been made to update the implementation to the approved version of OGC API Tiles and the current draft version OGC API Maps. A working instance of the MiraMon web client implementation was prepared showing collections from multiple providers.

[[img_miramon_maps_1]]
.Screenshot of the Miramon Map Browser with a combination of several collections (or layers) in the same client using different OGC protocols and APIs, like WMS, WMTS, OGC API - Maps, OGC API - Tiles, and SensorThings API
image::../images/miramon_maps_1.png[align="center"]

After that, the work focused on having a full implementation of the OGC API - Maps in our web client to allow end users to add collections from external server. The map client is able to establish the connection with a server from the landing page, inspect and follow the links and make the necessary requests to obtain a list of available map collections and their main characteristics.

The interface allows end users to indicate the landing page of the service that should be explored. Once explored, it displays a list of map collection available and allows to users select the collection or collections to add them as layer in the legend and in the map screen.
The following images show the .

[[img_miramon_maps_2]]
.Screenshot of the first step of the process for adding collections to the client from a OGC API - Maps compatible landing page prepared by Cubewerx
image::../images/miramon_maps_2.png[align="center"]

[[img_miramon_maps_4]]
.Screenshot of the Eurogeographics map served by the Cubewerx API.
image::../images/miramon_maps_4.png[align="center"]

Finally, the working shifted to connecting to map collections from OCG API - Tiles so that the end user can be added tiled maps to the client. The work consist on obtaining the tiled description and the list of tiled maps available in a service from the landing page. The work was more extensive that we anticipated and in the process of an in-depth review of the standard documents some difficulties have been found to properly understand some aspects. A suggestion for incorporating more coding examples in some of the requirements classes was made.

==== OGC Sensor Things API implementation

When working with a large amount of citizen data accessible through a STA service. In particular, trying to request the necessary data to present a map with a the large volume of features of interest can very slow and inefficient. To solve two approaches to tessellate the data has been tested and others proposed.

===== Some discussions on allowing tile requests in STA

An approach based on the combinations of OGC API - Tiles and STA will require modifying the current STA standard into support a request such as:

https://cos4cloud.demo.secure-dimensions.de/staplus/v1.1/TileMatrixSetId("WorldMercatorWGS84Quad")/tileMatrix(45)/TileRow(3)/TileCol(2)?$select=feature

Others approaches were discussed based on the extension of the Well Known Text filtering syntax to allow specifies new conditions and this can be something such as one of the following:

https://cos4cloud.demo.secure-dimensions.de/staplus/v1.1/FeaturesOfInterest/?$select=feature&$filter=properties/tilematrixset eq 'WorldMercatorWGS84Quad' and properties/tilematrix eq 4 and properties/tilerow eq 6 and properties/tilerow eq 10

https://cos4cloud.demo.secure-dimensions.de/staplus/v1.1/FeaturesOfInterest/?$select=feature&$filter=properties/tilematrixset eq 'WorldMercatorWGS84Quad'($filter=properties/tilematrix eq 4($filter=properties/tilerow eq 6 ($filter=properties/tilerow eq 10)))

https://cos4cloud.demo.secure-dimensions.de/staplus/v1.1/DataStream/?$select=feature&$expand=Locations&$filter=tilematrixset eq 'WorldMercatorWGS84Quad' and tilematrix eq 4 and tilerow eq 6 and tilerow eq 10

===== A client side implementation

A client-based tessellation solution was implemented in the sprint that addressed the situation of a server that offers a significant number of vector objects, whether those objects represent features, sensors, or their observations. This approach requires to implement two aspects directly in the client side: a tile matrix set and a "pre-fetch" STA request for the  number of features in a tile.

By defining a tile matrix set in several zoom in the client side, parallel tiled requests based on this division can be done to the server by specifying the bounding box of each tile without changing anything in the standard or the server implementations. In addition, only the tiles with a number of objects below a threshold will be completely requested.

Miramon was configured to issue a request for each STA tile twice, the first request is for getting the count (i.e. number of features of interest in a tile), and then second request is for getting the actual features of interest. The number of features of interest is requested to the STA server in a prefetch request. Only if the count of the features in the “tile” requested is greater than the threshold, only the number of features of interest is represented in the center of the tile with the presentation of the number of objects in each tile. Otherwise, the full description of the features of interest in the tile is requested and each feature of interested is represented in the screen. This approach is proposed by the https://github.com/DataCoveEU/STAM[STAM library] and it has been implemented from scratch in the MiraMon Map Browser using the same principles.

[[img_miramon_sta_2]]
.Screenshot of the MiraMon Map Browser requesting some tiles with the count of features of interest represented as big circles and others with the features of interest represented as small red dots. In addition, the information related with a particular observation is shown, including a picture.
image::../images/miramon_sta_2.png[align="center"]

[[img_miramon_sta_3]]
.Screenshot of the MiraMon Map Browser showing the URLs requested for each tile where the each bounding box can be seen expressed in WKT as a polygon.
image::../images/miramon_sta_3.png[align="center"]

===== A Server side implementation

Secure Dimensions has contributed to this sprint a server side implementation of tiles of observations. In this case a OGC API - Tiles is used as a facade for STA. The server implementing the OGC API - Tiles, renders the STA observation in PNG on-the-flight that is immediately delivered to the client. The MiraMon Map Browser is used as a client for this approach in other to visually verify that both server and client side times generate the same view. Further work is need to evaluate which of the two approaches could be more efficient in concrete use cases.

[[img_miramon_sta_4]]
.Screenshot of the MiraMon Map Browser comparing the response of the the Secure Dimensions OGC API - tiles facade (bottom, represented as black dots) with a STA with the client side tile approach (top, represented as red dots) as described in the previous subsection. Spatial concordance between the position of the features of interest is checked.
image::../images/miramon_sta_4.png[align="center"]
